---
import DayIcon from "@/assets/day.svg";
import NightIcon from "@/assets/night.svg";
import themeConfig from "@/config";

const defaultThemeMode = themeConfig.color.mode;
---

<button
  id="theme-toggle-button"
  class="cursor-pointer"
  aria-label="Switch light/dark theme"
>
  <!-- 白天图标 -->
  <DayIcon
    class="day-icon transition-opacity duration-300"
    height={24}
    width={24}
  />
  <!-- 黑夜图标 -->
  <NightIcon
    class="night-icon transition-opacity duration-300"
    height={24}
    width={24}
  />
</button>

<script is:inline define:vars={{ defaultThemeMode }}>
  function applyTheme(isDark, persist = true) {
    document.documentElement.classList.toggle("dark", isDark);
    if (persist) {
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }
    document.dispatchEvent(new Event("theme-changed"));
  }

  function initializeTheme() {
    const storedTheme = localStorage.getItem("theme");
    const prefersDark = window.matchMedia(
      "(prefers-color-scheme: dark)",
    ).matches;

    if (storedTheme === "dark" || storedTheme === "light") {
      applyTheme(storedTheme === "dark", false);
      return;
    }

    const isDark =
      defaultThemeMode === "auto" ? prefersDark : defaultThemeMode === "dark";

    applyTheme(isDark, false);
  }

  function toggleTheme() {
    applyTheme(!document.documentElement.classList.contains("dark"), true);
  }

  function handleThemeToggleClick(event) {
    const target = event.target instanceof Element ? event.target : null;
    if (!target?.closest("#theme-toggle-button")) {
      return;
    }

    if (
      document.documentElement.classList.contains("reduce-motion") ||
      typeof document.startViewTransition !== "function"
    ) {
      toggleTheme();
      return;
    }

    document.documentElement.style.setProperty(
      "view-transition-name",
      "animation-theme-toggle",
    );
    document.documentElement.setAttribute("data-theme-changing", "");

    const transition = document.startViewTransition(toggleTheme);
    transition.finished.finally(() => {
      document.documentElement.style.removeProperty("view-transition-name");
      document.documentElement.removeAttribute("data-theme-changing");
    });
  }

  initializeTheme();
  document.addEventListener("click", handleThemeToggleClick);

  window
    .matchMedia("(prefers-color-scheme: dark)")
    .addEventListener("change", (event) => {
      if (!localStorage.getItem("theme")) {
        applyTheme(event.matches, false);
      }
    });
</script>

<style>
  .day-icon,
  .night-icon {
    fill: currentColor;
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
  }

  :root:not(.dark) .day-icon {
    color: #000000;
  }

  :root:not(.dark) .night-icon {
    display: none;
  }

  :root.dark .night-icon {
    color: #ffffff;
  }

  :root.dark .day-icon {
    display: none;
  }

  @media (prefers-reduced-motion: no-preference) {
    ::view-transition-group(root) {
      animation-duration: 0.5s;
    }
  }
</style>

---
import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import { getArticleDescription } from "@/utils/description";
import themeConfig from "@/config";
import Comment from "@/components/Comment/Overview.astro";
import Division from "@/components/styles/Division.astro";
import ArticleTags from "@/components/meta/ArticleTags.astro";
import ArticleMeta from "@/components/meta/ArticleMeta.astro";
import TOC from "@/components/meta/TOC.astro";
import SocialShare from "@/components/meta/SocialShare.astro";
import Layout from "@/layouts/Layout.astro";
import { checkArticleSlugDuplication } from "@/utils/content";

export async function getStaticPaths() {
  const articles = await getCollection("articles");

  const duplicates = await checkArticleSlugDuplication(articles);
  if (duplicates.length > 0) {
    throw new Error(`Duplicate article slugs:\n${duplicates.join("\n")}`);
  }

  type PathItem = {
    params: { slug: string };
    props: { article: CollectionEntry<"articles"> };
  };

  const paths: PathItem[] = [];

  articles.forEach((article: CollectionEntry<"articles">) => {
    if (import.meta.env.DEV || !article.data.draft) {
      const slug = article.data.permalink || article.id;

      paths.push({
        params: { slug: `${slug}/` },
        props: {
          article,
        },
      });
    }
  });

  return paths;
}

const { article } = Astro.props;
const { author } = themeConfig.site;
const isSNSSharingActive = themeConfig.socialShare.activated;
const slug = article.data.permalink || article.id;
const description = getArticleDescription(article, "meta");
const shareUrl = new URL(Astro.url.pathname, themeConfig.site.url).toString();
const { Content, headings } = await render(article);
---

<Layout
  articleTitle={article.data.title}
  articleID={article.slug}
  articleDescription={description}
>
  <TOC headings={headings} />
  <div class="max-w-3xl w-full px-4 mx-auto mb-6 markdown">
    <div class="relative">
      <h1 class="article-title">
        <span transition:name={`article-${slug}`} data-disable-theme-transition>
          {article.data.title}
        </span>
      </h1>
    </div>
    <ArticleMeta author={author} publishDate={article.data.published} />
    <ArticleTags article={article} />

    <div id="article-content">
      <Content />
      <div id="article-copyright"></div>
      <a href="/articles/">返回文章页面</a>
      {
        isSNSSharingActive && (
          <Division />
          <SocialShare
            title={article.data.title}
            url={shareUrl}
            summary={description}
          />
        )
      }
      <Division />
      <Comment />
    </div>
  </div>
</Layout>
